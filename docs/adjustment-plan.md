# MMemory 调整计划（2024-09）

## 一、背景
- 版本：v0.0.1
- 目标：确保提醒调度、通知发送与交互流程满足《MMemory-Specs-v0.0.1》中的核心需求。
- 触发：系统评估发现关键提醒流程存在调度与通知缺口，影响需求达成。

## 二、已知问题
1. **提醒调度未绑定新建记录**
   - `cmd/bot/main.go` 在实例化 `reminderService` 后未调用 `SetScheduler`，导致新增提醒不会即时注册到调度器，仅在程序重启时加载。
2. **提醒推送缺失用户信息**
   - `schedulerService.executeReminder` 创建的 `ReminderLog` 未预加载 `Reminder` 与 `User`，`notificationService.SendReminder` 因 `TelegramID == 0` 抛错，提醒消息无法发送。
3. **延期提醒链路受阻**
   - 由于上两项问题，延期创建的临时提醒同样无法触发推送，影响“延期/跟进”体验。

## 三、调整目标
- 目标 G1：新增/更新提醒实时注册到调度器，无需重启即可生效。
- 目标 G2：调度任务生成的提醒日志具备完整上下文，可成功向用户推送。
- 目标 G3：延期、关怀等二次流程能够无阻塞地执行。
- 目标 G4：关键路径具备单元/集成测试验证，防止回归。

## 四、行动计划
| 序号 | 行动 | 责任 | 产出 | 验收 | 预计工时 |
|------|------|------|------|------|----------|
| A1 | 在 `cmd/bot/main.go` 中将 `schedulerService` 注入 `reminderService` (`SetScheduler`) | 后端 | 代码变更 | 新建提醒后立即触发调度 | 0.5h |
| A2 | 调整 `schedulerService.executeReminder`：载入带 `User` 的 `Reminder`，或在创建 `ReminderLog` 时补齐关联 | 后端 | 代码变更 | 推送消息包含正确的 `TelegramID` | 1h |
| A3 | 为延期/跟进流程编写集成测试（模拟提醒执行、调用通知） | 后端 & QA | 测试用例 | 测试覆盖延迟与关怀处理 | 1.5h |
| A4 | 补充变更说明至 `MMemory-Specs`/`README`（新增调度说明、配置注意事项） | 技术文档 | 文档更新 | 文档同步调整内容 | 0.5h |

## 五、时间安排
- T+0 天：完成 A1 ~ A2 并提交合并请求。
- T+1 天：完成 A3 测试，所有测试通过。
- T+1 天：同步文档（A4），准备验收。
- T+2 天：由产品/QA 复测核心流程，确认关闭该调整计划。

## 六、风险与缓解
- **调度器变更引发并发问题**：在测试环境多次创建/删除提醒验证；必要时增加锁或队列。
- **消息推送仍失败**：增加错误日志与告警，复核 Bot Token 与网络配置。
- **测试不充分**：测试用例覆盖提醒创建、执行、延期、超时关怀至少各1例。

## 七、验证与交付标准
- `go test ./...` 全部通过，新增测试覆盖调度、通知关键路径。
- 手动模拟：创建每日提醒后无需重启可收到消息；点击“延期1小时”后再次收到提醒。
- 文档版本更新完成并记录在变更日志。
- 通过代码评审并部署至测试环境验证。
